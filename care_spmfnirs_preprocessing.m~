%% CARE Preprocessing with fNIRS-SPM
%% Step 1
% Convert nirscout data to fnirs-spm format
srcFolder = '/Volumes/INTENSO/CARE/DualfNIRS_CARE_rawData/';                
sourceList    = dir([srcFolder 'CARE_*']);
sourceList    = struct2cell(sourceList);
sourceList    = sourceList(1,:);
numOfSources  = length(sourceList);

for i=1:numOfSources
 dyad=sourceList(i);

Sub1SrcDir  = strcat(srcFolder, dyad, '/Subject1/');
Sub2SrcDir  = strcat(srcFolder,dyad, '/Subject2/');

Sub1_wl1File = strcat(Sub1SrcDir, dyad, '.wl1');
Sub1_wl2File = strcat(Sub1SrcDir, dyad, '.wl2');
Sub1_hdrFile = strcat(Sub1SrcDir, dyad, '.hdr');

Sub2_wl1File = strcat(Sub2SrcDir, dyad, '.wl1');
Sub2_wl2File = strcat(Sub2SrcDir, dyad, '.wl2');
Sub2_hdrFile = strcat(Sub2SrcDir, dyad, '.hdr');

F1=  [Sub1_wl1File
    Sub1_wl2File
    Sub1_hdrFile];
spm_fnirs_read_nirscout(F1);

F2=  [Sub2_wl1File
    Sub2_wl2File
    Sub2_hdrFile];
spm_fnirs_read_nirscout(F2);
end

clear 
clc

%% Step 2
% Calculate optical density changes from light intensity and preprocess
% with MARA and Bandstopfilter (butter), then transform to hemoglobin
% changes

srcFolder = '/Volumes/INTENSO/CARE/DualfNIRS_CARE_rawData/';
sourceList    = dir([srcFolder 'CARE_*']);
sourceList    = struct2cell(sourceList);
sourceList    = sourceList(1,:);
numOfSources  = length(sourceList);

for i=1:numOfSources
 dyad=sourceList(i);

Sub1SrcDir  = strcat(srcFolder, dyad, '/Subject1/');
Sub2SrcDir  = strcat(srcFolder,dyad, '/Subject2/');

Sub1_NIRSFile = strcat(Sub1SrcDir, 'NIRS.mat');
Sub2_NIRSFile = strcat(Sub1SrcDir, 'NIRS.mat');

load(Sub1_NIRSFile{1,1});
y_ch=y;
P_ch=P;
load(Sub2_NIRSFile{1,1});
y_cg=y;
P_cg=P;

% Function to calculate optical density data
[Y_ch.od, P_ch] = spm_fnirs_calc_od(y_ch, P_ch);
[Y_cg.od, P_cg] = spm_fnirs_calc_od(y_cg, P_cg);

% Apply MARA for motion artifact correction
% identify channels of interest 

mask = ones(1, P_ch.nch); 
mask = mask .* P_ch.mask;
ch_roi = find(mask ~= 0); 

% display time series of fNIRS data
%spm_fnirs_viewer_timeseries(od_ch, P, [], ch_roi);

    K.M.type = 'MARA';
    chs = ch_roi;
    K.M.chs = chs;
    K.M.L = 1;
    K.M.th = 3;
    K.M.alpha = 5;
    K.C.type = 'Band-stop filter';
    K.C.cutoff = [0.12 0.35; 0.7 1.5];                                     % '[0.12 0.35; 0.7 1.5]'
    K.D.type = 'no';
    fs = P_ch.fs;
    K.D.nfs = fs;
    K.H.type = 'no';
    P_ch.K = K;
    P_cg.K = K;
   
    sfname = fullfile(spm_file(P_ch.fname.nirs, 'path'), 'motion_params.mat');
    save(sfname{1, 1}, 'chs', spm_get_defaults('mat.format'));
    sfname = fullfile(spm_file(P_cg.fname.nirs, 'path'), 'motion_params.mat');
    save(sfname, 'chs', spm_get_defaults('mat.format'));
    
[Y_ch.fy, P_ch] = spm_fnirs_preproc(Y_ch.od, P_ch); 
[Y_cg.fy, P_cg] = spm_fnirs_preproc(Y_cg.od, P_cg); 

% Conversion to hemoglobin changes
%P = spm_fnirs_specify_params(P);
P_ch.wav= [760 840];
P_ch.age= 5; % or 43 for caregivers
P_ch.d = 3;
P_ch.acoef = [1.4033    3.8547; 2.5488    1.7990];
P_ch.dpf = [5.5067 4.6881];

P_cg.wav= [760 840];
P_cg.age= 36;
P_cg.d = 3;
P_cg.acoef = [1.4033    3.8547; 2.5488    1.7990];
P_cg.dpf = [5.5067 4.6881];

[Y_ch.hbo, Y_ch.hbr, Y_ch.hbt] = spm_fnirs_calc_hb(Y_ch.fy, P_ch);
[Y_cg.hbo, Y_cg.hbr, Y_cg.hbt] = spm_fnirs_calc_hb(Y_cg.fy, P_cg);


% save files
    P_ch.fname.nirs = fullfile(Sub1SrcDir, 'NIRS.mat');
    save(P_ch.fname.nirs{1,1}, 'Y_ch', 'P_ch'); 
    P_cg.fname.nirs = fullfile(Sub2SrcDir, 'NIRS.mat');
    save(P_cg.fname.nirs{1,1}, 'Y_cg', 'P_cg'); 
    clear
    clc
end
